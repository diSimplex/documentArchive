#!/usr/bin/env ruby

# This ruby script creates an initial LaTeX document in the current 
# directory. This directory is assumed to be a git project recently 
# initialized from either our local gitolite instance or from GitHub. 
# When completed this command will create all of the required 
# supporting files to integrate this paper as a subCookbook of the 
# PerceptiSys latexCookbook.

# Get the location of the latexCookbook on this computer
#
latexCookbookDir = "%%LATEX_COOKBOOK_DIR%%";

# Get the location of the latexCookbook creation templates
#
templateDir = '/recipes/create/templates';

# Get the paper name
#
paperName = File.basename(Dir.pwd);

# Check to make sure we ONLY have the name of the document type to 
# create...
# 
# If not then we tell the user the expected usage parameters
#
if ARGV.size != 1 then
  puts "\nusage: createLaTeXDocument <<documentType>>";
  puts "\n\tWe assume that the current directory is a";
  puts "\tproperly cloned GitOLite or GitHub project.";
  puts "\n\tThe name of the document will be derived";
  puts "\tfrom the name of the directory.";
  puts "\n\tThe <<documentType>> must be one of:";
  Dir.glob(latexCookbookDir+'/documentTypes/*.conf').sort.each do | aDocType |
    puts "\t\t"+File.basename(aDocType,'.conf');
  end
  puts "\n";
  exit(-1);
end

# get the document type
#
documentType = ARGV.shift;

# create the cookbook configuration file
#
require 'erubis'
eruby = Erubis::Eruby.new(IO.read(latexCookbookDir + templateDir + '/cookbook.conf.erb'))
File.open('cookbook.conf', 'w') do | io |
  io.write(eruby.result(binding()));
end

# create the cookbook rake file
#
eruby = Erubis::Eruby.new(IO.read(latexCookbookDir + templateDir + '/cookbook.rake.erb'))
File.open('cookbook.rake', 'w') do | io |
  io.write(eruby.result(binding()));
end

# create the tex directory
#
system "mkdir -p tex"

# create the .gitignore.d directory
#
system "mkdir -p .gitignore.d"

# Let the latexCookbook do the cooking...
#
system "echo cook -c documentTypes/#{documentType} create"
system "cook -c documentTypes/#{documentType} create"

# Do the initial commit
#
system "echo git add -A"
system "git add -A"
system "echo git commit -m 'created LaTeX document'"
system "git commit -m 'created LaTeX document'"
