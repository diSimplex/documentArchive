% A ConTeXt document [master document: diSimp.tex]

\chapter[title=Setting up diSimp documents]

\startMkIVCode
\setupinteraction[
  state=start,
  color=green,
  stype=bold
]

\placebookmarks%
  [ % these are the headers to bookmark (the order here seems important :-(
    part,
    chapter,
    section,    chapterAppendix,
    subsection, subChapterAppendix, sectionAppendix,
  ]
  [ % these are the headers which will be OPEN in the bookmark list
    part,
    chapter,
    section, chapterAppendix
  ]

\setupinteractionscreen[option=bookmark]

\setupindenting[medium,yes]

% do not indent after itemize
\setupitemgroup[itemize][indentnext=no]

% indent the paragraphs after all sectioning heads 
\setupheads[indentnext=yes]
\setuphead[part][placehead=yes]

% indent paragraphs after formulas if there is a blank space in between
\setupformulas[indentnext=auto] 

% block quotes
\definedelimitedtext
  [BlockQuote]
  [\v!blockquote]
\setupdelimitedtext
  [BlockQuote]
  [
    style=\sl,
    before={\setupinterlinespace[line=2.4ex]\blank[1ex]},
    after={\blank[1ex]}
  ]

%\usebtxdataset[joylolBib.lua]
\usebtxdefinitions[apa]
%\setupbtx[apa:cite][ % see mkiv-publications.pdf page: 15
%  alternative=short
%]
%\setupbtxrendering[apa][ % see mkiv-publications.pdf page: ??
%  sorttype=short,
%  numbering=short
%]
\setupbtxlist[apa][
  alternative=paragraph,
  width=fit,
  distance=.5em,
  margin=3em % hanging list
]

% TITLE PAGES

\def\setShortTitle#1{

  \setuppagenumbering
    [
      alternative=doublesided,
      way=bypart
    ]

  \setupheadertexts[]
  \setupheadertexts[text]
    [\setups{oddPageHeader}]
    [\setups{headerBar}]
    [\setups{headerBar}]
    [\setups{evenPageHeader}]
    
  \startsetups[headerBar]
    \framed
      [
        topframe=off,
        leftframe=off,
        rightframe=off,
        bottomframe=on,
        width=\textwidth
      ]{
        \hfill
      }
  \stopsetups
  
  \startsetups[oddPageHeader]
    \framed
      [
        topframe=off,
        leftframe=off,
        rightframe=off,
        bottomframe=on,
        width=\textwidth
      ]{
        \rlap{\headnumber[chapter][current]}
        \hfill
        \getmarking[chapter]
      }
  \stopsetups

  \startsetups[evenPageHeader]
    \framed
      [
        topframe=off,
        leftframe=off,
        rightframe=off,
        bottomframe=on,
        width=\textwidth
      ]{
        \getmarking[section]
        \hfill
        \llap{\headnumber[section][current]}
      }
  \stopsetups

  \setupfootertexts[]
  \setupfootertexts
    [\setups{oddPageFooter}]
    [\setups{footerBar}]
    [\setups{footerBar}]
    [\setups{evenPageFooter}]

  \startsetups[footerBar]
    \framed
      [
        topframe=on,
        leftframe=off,
        rightframe=off,
        bottomframe=off,
        width=\textwidth
      ]{
        \hfill
      }
  \stopsetups
  
  \startsetups[oddPageFooter]
    \framed
      [
        topframe=on,
        leftframe=off,
        rightframe=off,
        bottomframe=off,
        width=\textwidth
      ]{
        \rlap{\pagenumber}
        \hfill
        \llap{#1}
      }
  \stopsetups

  \startsetups[evenPageFooter]
    \framed
      [
        topframe=on,
        leftframe=off,
        rightframe=off,
        bottomframe=off,
        width=\textwidth
      ]{
        \rlap{#1}
        \hfill
        \llap{\pagenumber}
      }
  \stopsetups
}

\def\placeTitlePage#1#2#3{
  \startmakeup

  \blank[5cm]
  
  \startalignment[center]
  \dontleavehmode
  \tfd\bf
  #1
  \stopalignment

  \blank[1cm]

  \startalignment[center]
  \dontleavehmode
  \tfc\bf
  #2
  \stopalignment

  \blank[1cm]

  \startalignment[center]
  \dontleavehmode
  \tfb\bf
  #3
  \stopalignment

  \blank[8cm]

  \startalignment[flushright]
  \dontleavehmode
  \tfa\bf
  \bTABLE
    \setupTABLE[r][each][frame=off]
    \bTR \bTD Dr Stephen Gaito \eTD \eTR
    \bTR \bTD PerceptiSys Ltd \eTD \eTR
    \bTR \bTD \date \eTD \eTR
  \eTABLE
  \stopalignment

  \blank[5cm]

  \startalignment[center]
  Perish \emph{then} Publish Press.
  \stopalignment

  \stopmakeup
}
\stopMkIVCode


\section[title=Indexing Symbols and Subjects]

\startMkIVCode

\defineprocessor
  [definition]
  [style=bold]

\defineregister
  [indexSymbol]
  [indexSymbols]

\def\defineWord#1{\index[definition->]{#1}#1}
\def\defineSymb#1{\indexSymbol[definition->]{#1}#1}
\def\defineBoth#1{\index[definition->]{#1}\indexSymbol[definition->]{#1}#1}

\def\useWord#1{\index{#1}#1}  
\def\useSymb#1{\indexSymbol{#1}#1}  
\def\useBoth#1{\index{#1}\indexSymbol{#1}#1}

\stopMkIVCode

\section[title=DiSimplex document Environments and Components macros]

We specialize the standard \type{\environment} and \type{\component} macros 
to ensure two things:

\startitemize[n]

\item \bold{complex collections of sub-components found in \quote{relative} 
paths}. DiSimp documents may be built using multiple associated artifacts 
such as, for example, CoAlgebras. We need the ability to specify 
components which might not be in the traditional \ConTeXt\ hierarchical 
directory structures.

\item \bold{knowledge of \quote{doc} directories}. DiSimp documents usually 
produce computational artifacts which might need separate compilation. To 
keep these \emph{derived} computational artefacts separate from the main 
document, we keep \ConTeXt\ files in \quote{doc} directories and any 
derived computational artefacts in \quote{buildDir} directories.

\stopitemize

We implement \type{\startDiSimpComponent} and \type{\stopDiSimpComponent} 
in order to ensure that our complex collection of nested components does 
not break \ConTeXt's native \quote{project}, \quote{product}, and 
\quote{component} system. We effectively only make use of 
\quote{components}, but we explicitly allow them to be nested multiple 
levels deep. To do this we only actually let \ConTeXt\ \quote{see} the 
outer most start/stop \quote{component} declaration.

\startMkIVCode

%% repeat after me.... this WILL break!!!
%%
%% this call pattern has been modeled upon the
%% definition of \environment in file-job.mkvi
%% on 2018/Nov/07 (experimental distribution)
%%
\unexpanded\def\diSimpEnvironment{%
  \doifelsenextoptionalcs%
    \useDiSimpEnvironment%
    \syst_structure_arg_disimp_environment%
}

\def\syst_structure_arg_disimp_environment  #1 {\useDiSimpEnvironment  [#1]}

\unexpanded\def\useDiSimpEnvironment  [#1]{%
  \directlua{
    thirddata.diSimp.diSimpComponent('environment', '#1')
  }
}

%% repeat after me.... this WILL break!!!
%%
%% this call pattern has been modeled upon the
%% definition of \startcomponent in file-job.mkvi
%% on 2018/Nov/07 (experimental distribution)
%%
\unexpanded\def\startDiSimpComponent{%
  \doifelsenextoptionalcs%
    \useStartDiSimpComponent%
    \syst_structure_arg_start_disimp_component%
}

\def\syst_structure_arg_start_disimp_component  #1 {\useStartDiSimpComponent[#1]}

\unexpanded\def\useStartDiSimpComponent  [#1]{%
  \directlua{
    thirddata.diSimp.startDiSimpComponent('component', '#1')
  }
}

\def\stopDiSimpComponent{%
  \directlua{
    thirddata.diSimp.stopDiSimpComponent('component')
  }
}

%% repeat after me.... this WILL break!!!
%%
%% this call pattern has been modeled upon the
%% definition of \component in file-job.mkvi
%% on 2018/Nov/07 (experimental distribution)
%%
\unexpanded\def\diSimpComponent{%
  \doifelsenextoptionalcs%
    \useDiSimpComponent%
    \syst_structure_arg_disimp_component%
}

\def\syst_structure_arg_disimp_component  #1 {  \useDiSimpComponent  [#1]}

\unexpanded\def\useDiSimpComponent  [#1]{%
  \directlua{
    thirddata.diSimp.diSimpComponent('component', '#1')
  }
}

\def\popDiSimpPath{
  \directlua{
    thirddata.diSimp.popDiSimpPath()
  }
}

\def\currentDiSimpPath{
  \directlua{
    tex.print(thirddata.diSimp.lastDiSimpPath())
  }
}

\stopMkIVCode

\startLuaCode

local insideComponent = {}
insideComponent['component']   = 0
insideComponent['environment'] = 0
insideComponent['product']     = 0
insideComponent['project']     = 0

local diSimpPaths   = {}
local pathSeparator = package.config:sub(1, 1)

local function lastDiSimpPath()
  return diSimpPaths[#diSimpPaths] or ""
end

diSimp.lastDiSimpPath = lastDiSimpPath

local function pushDiSimpPath(aFullPath)
  texio.write_nl('pushDiSimpPath('..aFullPath..')')
  local aFullPathDir =
    aFullPath:gsub('[^'..pathSeparator..']+$', '')
  texio.write_nl('  aFullPathDir: ['..aFullPathDir..']')
  if aFullPathDir:sub(-1) ~= '/' then
    aFullPathDir = aFullPathDir..pathSeparator
  end
  tInsert(diSimpPaths, aFullPathDir)
  for i, aPath in ipairs(diSimpPaths) do
    texio.write_nl('diSimpPaths['..toStr(i)..']: ['..aPath..']')
  end
end

-- repeat after me... this WILL break!!!
--
-- the use of environments.arguments.fulljobname
-- was infered from grep'ing the experimental distribution
-- for fulljobname and finding it defined in the
-- the environment table. 
-- (defined in core-sys.lua)
--
pushDiSimpPath(file.collapsepath(environment.arguments.fulljobname,true))

local function popDiSimpPath()
  texio.write_nl('popDiSimpPath()')
  tRemove(diSimpPaths)
  for i, aPath in ipairs(diSimpPaths) do
    texio.write_nl('diSimpPaths['..toStr(i)..']: ['..aPath..']')
  end
  texio.write_nl('<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<')
end

diSimp.popDiSimpPath = popDiSimpPath

local function findDiSimpPath(curBasePath, componentPath, origBasePath)
  texio.write_nl('findDiSimpPath(['..curBasePath..'],['..componentPath..'],['..origBasePath..'])')
  local potentialPath =
    file.collapsepath(curBasePath..componentPath, true)
  if lfs.attributes(potentialPath..'.tex', 'mode') == 'file' then
    texio.write_nl('found: ['..potentialPath..']')
    return potentialPath
  end
  potentialPath =
    file.collapsepath(curBasePath..'doc/'..componentPath, true)
  if lfs.attributes(potentialPath..'.tex', 'mode') == 'file' then
    texio.write_nl('found: ['..potentialPath..']')
    return potentialPath
  end
  if curBasePath == '' or curBasePath == pathSeparator then
    texio.write_nl('no path found using: ['..origBasePath..componentPath..']')
    return file.collapsepath(origBasePath..componentPath, true)
  end
  local newCurBasePath =
    curBasePath:gsub('[^'..pathSeparator..']+'..pathSeparator..'$','')
  return findDiSimpPath(newCurBasePath, componentPath, origBasePath)
end

local function diSimpComponent(componentType, componentPath)
  texio.write_nl('>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
  texio.write_nl('diSimpComponent(['..componentType..'],['..componentPath..'])')
  if componentType == 'environment' and 1 < insideComponent['component'] then
    -- do nothing
  else
    -- we are either NOT an environment
    -- OR we are an environment but inside the first start/stop component pair
    local basePath = lastDiSimpPath()
    local thisComponentPath = findDiSimpPath(basePath, componentPath, basePath)
    texio.write_nl(' thisComponentPath: ['..thisComponentPath..']')
    pushDiSimpPath(thisComponentPath)
    tex.print({
      '\\'..componentType..' '..thisComponentPath,
      '\\popDiSimpPath'
    })
  end
end

diSimp.diSimpComponent = diSimpComponent

local function startDiSimpComponent(componentType, componentName)
  texio.write_nl('startDiSimpComponent(['..componentType..'],['..componentName..']')
  for k,v in pairs(insideComponent) do
    texio.write_nl('insideComponent['..k..'] = '..toStr(v))
  end
  if insideComponent[componentType] < 1 then
    tex.print('\\start'..componentType..' '..componentName..'\\relax')
  end
  insideComponent[componentType] = insideComponent[componentType] + 1
  texio.write_nl(
    '\\startDiSimpComponent('..componentType..')'..
    '['..toStr(insideComponent[componentType])..']'
  )
end

diSimp.startDiSimpComponent = startDiSimpComponent

local function stopDiSimpComponent(componentType)
  texio.write_nl('stopDiSimpComponent(['..componentType..']')
  texio.write_nl(
    '\\stopDiSimpComponent('..componentType..')'..
    '['..toStr(insideComponent[componentType])..']'
  )
  insideComponent[componentType] = insideComponent[componentType] - 1
  for k,v in pairs(insideComponent) do
    texio.write_nl('insideComponent['..k..'] = '..toStr(v))
  end
  if insideComponent[componentType] < 1 then
    if insideComponent[componentType] < 0 then
      texio.write_nl('ERRROR: unbalanced number of \\stop'..componentType)
    end
    texio.write_nl('CALLING \\stop'..componentType)
    tex.print('\\stop'..componentType..'\\relax')
  end
end

diSimp.stopDiSimpComponent = stopDiSimpComponent

\stopLuaCode

\section[title=Setup chapter and section appendices]

\startMkIVCode

\defineconversionset[chapterAppendix][numbers,numbers,Characters][numbers]
\definehead
  [chapterAppendix]
  [\c!section=\s!section-3,
   \c!default=\v!section,
   sectionconversionset=chapterAppendix]

\definehead
  [subChapterAppendix]
  [\c!section=\s!section-4,
   \c!default=\v!subsection,
   sectionconversionset=chapterAppendix]

\definehead
  [subSubChapterAppendix]
  [\c!section=\s!section-5,
   \c!default=\v!subsubsection,
   sectionconversionset=chapterAppendix]

\defineconversionset[sectionAppendix][numbers,numbers,numbers,Characters][numbers]
\definehead
  [sectionAppendix]
  [\c!section=\s!section-4,
   \c!default=\v!subsection,
   sectionconversionset=sectionAppendix]

\definehead
  [subSectionAppendix]
  [\c!section=\s!section-5,
   \c!default=\v!subsubsection,
   sectionconversionset=sectionAppendix]

\definecombinedlist
  [\v!content]
  [\v!part,
   \v!chapter,
   \v!section,
   chapterAppendix,
   \v!subsection,
   subChapterAppendix,
   sectionAppendix,
   \v!subsubsection,
   subsubChapterAppendix,
   subSectionAppendix,
   \v!subsubsubsection,
   \v!subsubsubsubsection]
  [\c!level=\v!subsubsubsubsection,
   \c!criterium=\v!local]

\setuplist [chapterAppendix]       [\c!width=3\emwidth]
\setuplist [subChapterAppendix]    [\c!width=4\emwidth]
\setuplist [subSubChapterAppendix] [\c!width=5\emwidth]

\setuplist [sectionAppendix]    [\c!width=4\emwidth]
\setuplist [subSectionAppendix] [\c!width=5\emwidth]

\newdimen\appendixDimen

\def\startAppendicesBar{
  \startsidebar[rulethickness=10bp, rulecolor=gray, distance=10bp]
  \appendixDimen=\textwidth
  \advance\appendixDimen by 20bp
  \startsidebar[rulethickness=10bp, rulecolor=lightgray, distance=-\appendixDimen]
}

\def\stopAppendicesBar{
  \stopsidebar
  \stopsidebar
}

\def\startChapterAppendices{
  \directlua{thirddata.diSimp.startAppendices(3)}
  \startAppendicesBar
}
\def\startSectionAppendices{
  \directlua{thirddata.diSimp.startAppendices(4)}
  \startAppendicesBar
}

\def\stopChapterAppendices{
  \stopAppendicesBar
}
\def\stopSectionAppendices{
  \stopAppendicesBar
}

\stopMkIVCode

\startLuaCode

-- repeat after me... this WILL break!!!
--
local function startAppendices(sectionDepth)
  local numbers = structures.documents.data.numbers
  for i=sectionDepth,#numbers,1 do
    numbers[i] = 0
  end
end

diSimp.startAppendices = startAppendices

\stopLuaCode
